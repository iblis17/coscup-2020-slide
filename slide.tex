\documentclass[aspectratio=169]{beamer}

\usetheme{Berlin}

\usepackage{textcomp}

% Chinese typesetting
\usepackage{xeCJK}
\setCJKmainfont{HanWangWCL06}
\setmainfont{Fira Code}

\title{The Ports Framework Workshop}
\author{Iblis Lin \textlangle{}iblis@hs.ntnu.edu.tw\textrangle{}}

\setbeamertemplate{footline}[frame number]

\begin{document}


\begin{frame}
  \titlepage
\end{frame}

\begin{frame}[t,fragile]{Topics}
  \begin{itemize}
    \item Making a New Port
      \begin{itemize}
        \item Dir Structure
        \item ports-mgmt/porttools
        \item Description File
        \item Checksum File
        \item Package List
      \end{itemize}
    \item Upgrading a port
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Resources}
  \begin{itemize}
    \item \href{https://www.freebsd.org/doc/en_US.ISO8859-1/books/porters-handbook/book.html}{Porter's Handbook}
    \item \verb|/usr/ports/|
      \begin{itemize}
        \item \verb|Mk/bsd.port.mk|
      \end{itemize}
  \end{itemize}
\end{frame}

\section{Making a New Port}
\begin{frame}[t,fragile]{Dir Structure}
  \begin{itemize}
    \item Ports framework 本身是由一大堆的 \verb|Makefile| 堆砌而成
    \item 東西長在 \verb|/usr/ports/Mk/*|
    \item 一個簡單的範例 \verb|ports-mgmt/porttools|
  \end{itemize}

  \begin{verbatim}
  └─[iblis@GaeBuidhe]% find ports-mgmt/porttools
  ports-mgmt/porttools
  ports-mgmt/porttools/pkg-plist
  ports-mgmt/porttools/pkg-descr
  ports-mgmt/porttools/distinfo
  ports-mgmt/porttools/Makefile
  \end{verbatim}
\end{frame}

\begin{frame}[t,fragile]{Getting Started with ports-mgmt/porttools}
  \begin{itemize}
    \item \verb`mkdir ~/ports`
    \item \verb`git clone https://github.com/freebsd/freebsd-ports.git ~/ports/dev`
    \item \verb`cd ports/dev/devel`
    \item \verb`port create foo`
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Getting Started with ports-mgmt/porttools}
  \begin{itemize}
    \item \verb|make -V| 方便 debug
    \item E.g \verb|make -V PORTNAME|
  \end{itemize}
\end{frame}

\begin{frame}[t]{Makefile}
  \begin{itemize}
    \item Port framework 定義了 build 一個 port 所需要的 make target
    \item 每個 target 都還會有，pre-<target> 跟 post-<target> hooks 可以使用
  \end{itemize}
  \begin{enumerate}
    \item fetch
    \item extract
    \item patch
    \item configure
    \item build
    \item stage
    \item package
    \item install
  \end{enumerate}
\end{frame}

\begin{frame}[t,fragile]{Description File: pkg-descr}
  \begin{itemize}
    \item pkg-descr 放些關於這個 port 的介紹
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Checksum File}
  \begin{itemize}
    \item 設定好 \verb`MASTER_SITES`
    \item 如果用 GitHub 有 shorthand, e.g. \verb`math/openlibm`
  \end{itemize}
  \begin{block}{Autogenerated Checksum}
    \verb`make makesum`
  \end{block}
  \begin{itemize}
    \item 最後得到 \verb`distinfo`
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Package List: pkg-plist}
  \verb`pkg-plist` 即為 package list，裡面表列這個 port 會裝到 \verb`PREFIX` 的哪裡
  \begin{itemize}
      \item 這裡面都是相對路徑
      \item 可以手寫，也可以自動產出一份清單再來改
      \item \verb`make makeplist`
  \end{itemize}

  \begin{block}{PREFIX}
    \verb`└─[iblis@GaeBuidhe]% make -V PREFIX`

    \verb`/usr/local`
  \end{block}

\end{frame}

\begin{frame}[t,fragile]{Testing the Port via Poudriere}
  \begin{itemize}
    \item 先用 \verb`ports-mgmt/portlint` 來看看有沒有啥大問題
      \begin{itemize}
        \item 但 static anaylizer 有時候會抽筋
      \end{itemize}
    \item \verb`ports-mgmt/poudriere`
    \item Idea
      \begin{itemize}
        \item 在乾淨的環境 build port，透過 Jail
        \item 在不同的 world build，透過 Jail
        \item 用不同的 ports tree build
      \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Poudriere: Configure}
  \begin{itemize}
    \item 設定一下 \verb`/usr/local/etc/poudriere.conf`，通常就調一下 zfs 設定
    \item \verb`FREEBSD_HOST=https://download.FreeBSD.org`
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Poudriere: Set Up Jails}
  \begin{itemize}
    \item<1-> 先偷看一下哪些 RELEASE 版本正在 support
      \begin{itemize}
        \item \href{https://www.freebsd.org/releases/}{https://www.freebsd.org/releases/}
      \end{itemize}

    \item<2-> 建立一臺 12.1-RELEASE amd64 的 Jail
    \item<2-> \verb`# poudriere jail -c -j 121r -v 12.1-RELEASE`
    \item<3-> 再來是 12.1-RELEASE i386 的 Jail
    \item<3-> \verb`# poudriere jail -c -j 121r-i386 -v 12.1-RELEASE -a i386`
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Poudriere: Set Up Port Tree}
  \begin{itemize}
    \item 我習慣上，用 git clone ports tree 然後手動加入 poudriere
    \item \verb`poudriere ports -c -m null -M ~/ports/dev -p dev`
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Poudriere: testports}
  \begin{itemize}
    \item \verb`poudriere testport -j 121r      -p dev -o devel/foo`
    \item \verb`poudriere testport -j 121r-i386 -p dev -o devel/foo`
    \item e.g. \href{https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=233122}{\#233122}
    \item e.g. \href{https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=235872}{\#235872}
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Submitting to FreeBSD's Bugzilla}
  \begin{itemize}
    \item \verb`git add devel/foo`
    \item \verb`git diff --cached > foo.diff`
    \item \href{https://bugs.freebsd.org/bugzilla/enter_bug.cgi}{https://bugs.freebsd.org/bugzilla/enter\_bug.cgi}
  \end{itemize}
\end{frame}

\section{Updating a Port}
\begin{frame}[t,fragile]{Upgrading a Port}
  \begin{itemize}
    \item 其實所有流程都跟前面說的一樣
    \item 在開始前先去 Bugzilla 找有沒有正在進行中的 upgrading
  \end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Other Port Framework Features}
  \begin{itemize}
    \item \verb`OPTIONS` Framework 與 plist issue
      \begin{itemize}
        \item \href{https://www.freebsd.org/doc/en/books/porters-handbook/book.html#makefile-options}{https://www.freebsd.org/doc/en/books/porters-handbook/book.html\#makefile-options}
        \item \href{https://www.freebsd.org/doc/en/books/porters-handbook/book.html#plist}{https://www.freebsd.org/doc/en/books/porters-handbook/book.html\#plist}
      \end{itemize}
    \item \verb`USE` 與 \verb`USE_*`
      \begin{itemize}
        \item \href{https://www.freebsd.org/doc/en/books/porters-handbook/book.html#special}{https://www.freebsd.org/doc/en/books/porters-handbook/book.html\#special}
      \end{itemize}
    \item Flavors
      \begin{itemize}
        \item \href{https://www.freebsd.org/doc/en/books/porters-handbook/book.html#flavors}{https://www.freebsd.org/doc/en/books/porters-handbook/book.html\#flavors}
      \end{itemize}
  \end{itemize}
\end{frame}

\end{document}
